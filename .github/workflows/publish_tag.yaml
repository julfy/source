# GitHub Action that runs unit tests in an incoming pull request.
#
name: copy_tag
on:
  push:
    branches: [master]
    tags: ['*']
jobs:
  copy:
    runs-on: ubuntu-latest
    env:
      GITHUB_ACCESS_TOKEN: ${{ secrets.ACTIONS_ACCESS_TOKEN }}
      TO_COPY: "to_copy to_copy_content"
      TARGET_DIR: "target"
    steps:
      - name: Checkout source
        uses: actions/checkout@v2
      - name: Checkout and clean target
        run: |
          cd ..
          git clone "https://$GITHUB_ACCESS_TOKEN@github.com/julfy/copy.git" $TARGET_DIR
          cd $TARGET_DIR
          TRACKED=$(git ls-files | cut -d '/' -f 1 | sort | uniq)
          rm -rf $TRACKED
      - name: Copy to target
        run: |
          for f in $TO_COPY; do
            cp -r "$f" ../$TARGET_DIR;
          done
          pwd
          echo -la
      - name: Commit and tag
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          CM=${{ github.event.head_commit.message }}
          cd ../$TARGET_DIR
          echo "$BRANCH_NAME"
          echo "$CM"
          git checkout "$BRANCH_NAME" || git checkout -b "$BRANCH_NAME"
          echo '======='
          git add .
          git commit -m "$CM"
          if [ -eq "$BRANCH_NAME" "master" ]; then
              echo ">>>> master";
          else
              echo ">>>> tag";
          fi
          git tag "$BRANCH_NAME"
          git push origin --tags
